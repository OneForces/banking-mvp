<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Онлайн-банк · демо</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{ --fg:#111; --muted:#666; --line:#e5e7eb; --pill:#f3f4f6; }
    body{ font-family: system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,Arial; margin:24px; line-height:1.5; color:var(--fg); }
    h1{ margin-bottom:8px; }
    .muted{ color:var(--muted); }
    .row{ margin:16px 0; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; }
    .card{ border:1px solid var(--line); border-radius:12px; padding:16px; }
    .inline{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input, select{ padding:8px 12px; border-radius:8px; border:1px solid #ddd; font:inherit; }
    button, a.btn{ padding:8px 12px; border-radius:8px; border:1px solid #111; background:#111; color:#fff; text-decoration:none; cursor:pointer; }
    a.link{ color:#0a58ca; text-decoration:none; }
    .pill{ padding:6px 10px; border:1px solid var(--line); background:#f3f4f6; border-radius:999px; }
    .btn.secondary{ background:#fff; color:#111; border-color:#ddd; }
    small.k{ font-family: ui-monospace,SFMono-Regular,Consolas,Menlo,monospace; padding:2px 6px; border:1px solid #e5e7eb; border-radius:6px; background:#fafafa; }
  </style>
</head>
<body>
  <!-- Глобальная навигация -->
  <div th:replace="~{fragments/nav :: nav(${bank}, ${login}, ${consentId}, ${baseUrl})}"></div>

  <h1>Онлайн-банк · демо</h1>
  <div class="muted">Скелет приложения на Spring Boot: согласие, счета, <b>балансы</b>, транзакции; каталог продуктов.</div>

  <!-- Глобальный выбор банка -->
  <div class="row inline">
    <label for="bank">Банк:</label>
    <select id="bank">
      <option value="v" th:selected="${bank}=='v'">VBank</option>
      <option value="a" th:selected="${bank}=='a'">ABank</option>
      <option value="s" th:selected="${bank}=='s'">SBank</option>
    </select>
    <span class="muted">Переключатель влияет на все ссылки ниже.</span>
  </div>

  <div class="grid">
    <!-- Проверки доступности -->
    <div class="card">
      <h3>Проверка доступности</h3>
      <p class="muted">Быстрые health-пинги sandbox API.</p>
      <div class="row inline">
        <a class="btn secondary" id="health-link" href="/health/vbank" target="_blank">Открыть health</a>
        <span class="pill" id="health-hint">/health/vbank</span>
      </div>
      <div class="row">
        <a class="link" href="/health/vbank" target="_blank">VBank</a> ·
        <a class="link" href="/health/abank" target="_blank">ABank</a> ·
        <a class="link" href="/health/sbank" target="_blank">SBank</a>
      </div>
    </div>

    <!-- Каталог продуктов -->
    <div class="card">
      <h3>Каталог продуктов</h3>
      <p class="muted">Вклады/кредиты (UI) и «сырое» JSON.</p>
      <div class="row inline">
        <a class="btn" id="products-ui"
           th:href="@{/deposit/products(bank=${bank != null ? bank : 'v'}, login=${login})}">Открыть UI</a>
        <a class="btn secondary" id="products-json"
           th:href="@{/deposit/products.json(bank=${bank != null ? bank : 'v'}, login=${login})}" target="_blank">Открыть JSON</a>
      </div>
      <div class="row muted">
        Текущая ссылка: <small class="k" id="products-hint">/deposit/products?bank=v</small>
      </div>
    </div>

    <!-- Счета клиента -->
    <div class="card">
      <h3>Счета клиента</h3>
      <p class="muted">Создаём согласие и показываем счета. Для некоторых банков согласие будет <i>pending</i> (ожидает одобрения).</p>
      <form class="inline" method="get" th:action="@{/accounts}" id="accounts-form">
        <input type="hidden" name="bank" id="bank-hidden" th:value="${bank} ?: 'v'"/>
        <label for="login">Логин клиента:</label>
        <input id="login" name="login" type="text" th:value="${login} ?: 'team101-1'" placeholder="client_id клиента" required/>
        <button type="submit">Показать счета</button>
      </form>
      <div class="row muted">
        Эндпоинт: <small class="k" id="accounts-hint">/accounts?bank=v&login=…</small>
      </div>
    </div>

    <!-- Детали / Балансы / Транзакции -->
    <div class="card">
      <h3>Детали счёта, <b>балансы</b> и транзакции</h3>
      <p class="muted">Быстрые ссылки на страницы «Детали/Балансы» (в одной странице) и «История» по известному <code>accountId</code> и <code>consentId</code>.</p>
      <div class="row inline">
        <label>Account ID:</label>
        <input id="acc-id" type="text" placeholder="acc-123" style="min-width:220px"/>
      </div>
      <div class="row inline">
        <label>Consent ID:</label>
        <input id="consent-id" type="text" th:value="${consentId}" placeholder="consent-xyz" style="min-width:220px"/>
      </div>
      <div class="row inline">
        <a class="btn" id="acc-details" href="#">Открыть детали</a>
        <a class="btn secondary" id="acc-balances" href="#">Открыть балансы</a>
        <a class="btn secondary" id="acc-tx" href="#">Открыть транзакции</a>
      </div>
      <div class="row muted">
        Детали/Балансы: <small class="k" id="acc-details-hint">/accounts/{id}?bank=v&consentId=…</small>
      </div>
      <div class="row muted">
        Транзакции: <small class="k" id="acc-tx-hint">/accounts/{id}/transactions?bank=v&consentId=…</small>
      </div>
    </div>

    <!-- Статус согласия (debug) -->
    <div class="card">
      <h3>Статус согласия (debug)</h3>
      <p class="muted">Если есть <code>consent_id</code>, этим GET можно проверить статус:</p>
      <div class="row"><small class="k">/consents/&lt;bank&gt;/&lt;consent_id&gt;/status</small></div>
      <p class="muted">Пример: <a class="link" href="/consents/v/sample-consent/status" target="_blank">/consents/v/sample-consent/status</a></p>
    </div>
  </div>

  <div class="row muted">
    Подсказка: логины тестовых клиентов отличаются между банками.
    Для SBank подходят демо-логины вида <small class="k">demo-033</small>, <small class="k">demo-101</small> и т.п.
  </div>

  <script>
    const bankSel    = document.getElementById('bank');
    const bankHidden = document.getElementById('bank-hidden');

    const healthLink = document.getElementById('health-link');
    const healthHint = document.getElementById('health-hint');

    const prodUi   = document.getElementById('products-ui');
    const prodJson = document.getElementById('products-json');
    const prodHint = document.getElementById('products-hint');

    const accHint = document.getElementById('accounts-hint');

    const accIdInp    = document.getElementById('acc-id');
    const consentInp  = document.getElementById('consent-id');
    const loginInp    = document.getElementById('login');
    const accDetails  = document.getElementById('acc-details');
    const accBalances = document.getElementById('acc-balances');
    const accTx       = document.getElementById('acc-tx');
    const accDetailsHint = document.getElementById('acc-details-hint');
    const accTxHint      = document.getElementById('acc-tx-hint');

    function url(originlessUrl){ return originlessUrl.replace(location.origin,''); }

    function applyBank(b) {
      // health
      const healthMap = { v:'/health/vbank', a:'/health/abank', s:'/health/sbank' };
      healthLink.href   = healthMap[b] || '/health/vbank';
      healthHint.textContent = url(healthLink.href);

      // products
      const lg = (loginInp.value || '').trim();
      prodUi.href   = '/deposit/products?bank=' + b + (lg ? '&login=' + encodeURIComponent(lg) : '');
      prodJson.href = '/deposit/products.json?bank=' + b + (lg ? '&login=' + encodeURIComponent(lg) : '');
      prodHint.textContent = url(prodUi.href);

      // accounts form
      bankHidden.value = b;
      accHint.textContent = '/accounts?bank=' + b + '&login=…';

      // deep links by current inputs
      applyDeepLinks();
    }

    function applyDeepLinks(){
      const b  = bankHidden.value || 'v';
      const id = (accIdInp.value || '{id}').trim();
      const cs = (consentInp.value || '').trim();
      const lg = (loginInp.value || '').trim();

      const q = `bank=${b}` + (cs ? `&consentId=${encodeURIComponent(cs)}` : '') + (lg ? `&login=${encodeURIComponent(lg)}` : '');

      const detailsUrl  = `/accounts/${id}?${q}`;
      const balancesUrl = detailsUrl; // балансы на странице деталей
      const txUrl       = `/accounts/${id}/transactions?${q}`;

      accDetails.href  = detailsUrl;
      accBalances.href = balancesUrl;
      accTx.href       = txUrl;

      accDetailsHint.textContent = detailsUrl;
      accTxHint.textContent      = txUrl;
    }

    bankSel.addEventListener('change', () => applyBank(bankSel.value));
    accIdInp.addEventListener('input', applyDeepLinks);
    consentInp.addEventListener('input', applyDeepLinks);
    loginInp.addEventListener('input', applyDeepLinks);

    // init
    applyBank(bankSel.value || 'v');
  </script>
</body>
</html>
